# System Overview â€” Messenger Architecture

## ðŸ“¡ Communication Overview

## ðŸ§± ÐŸÐ¾Ð´Ñ…Ð¾Ð´ Ðº Ð¼ÐµÐ¶ÑÐµÑ€Ð²Ð¸ÑÐ½Ð¾Ð¼Ñƒ Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸ÑŽ

Ð’ Ñ€Ð°Ð¼ÐºÐ°Ñ… Ð¼Ð¸ÐºÑ€Ð¾ÑÐµÑ€Ð²Ð¸ÑÐ½Ð¾Ð¹ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ñ‹ Ð¼ÐµÑÑÐµÐ½Ð´Ð¶ÐµÑ€Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð¼ÐµÑ‚Ð¾Ð´Ñ‹ ÐºÐ¾Ð¼Ð¼ÑƒÐ½Ð¸ÐºÐ°Ñ†Ð¸Ð¸:

- **gRPC** â€” Ð´Ð»Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ñ‹Ñ… ÐºÐ¾Ð¼Ð°Ð½Ð´ Ð¼ÐµÐ¶Ð´Ñƒ ÑÐµÑ€Ð²Ð¸ÑÐ°Ð¼Ð¸
- **REST** â€” Ð´Ð»Ñ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ ÑƒÐ´Ð¾Ð±Ð½Ð¾ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ð¸)
- **ÐžÑ‡ÐµÑ€ÐµÐ´ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ (Kafka Ð¸Ð»Ð¸ NATS)** â€” Ð´Ð»Ñ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹Ð½Ð¾Ð¹ ÐºÐ¾Ð¼Ð¼ÑƒÐ½Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð¼ÐµÐ¶Ð´Ñƒ ÑÐµÑ€Ð²Ð¸ÑÐ°Ð¼Ð¸, Ð³Ð´Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€ÑƒÐµÐ¼Ð¾ÑÑ‚ÑŒ, Ð½Ð°Ð´Ñ‘Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð¸Ð»Ð¸ fan-out

---

## ðŸ”§ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ðµ Ð¿Ñ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð»Ñ‹ Ð¿Ð¾ ÑÐµÑ€Ð²Ð¸ÑÐ°Ð¼

| Ð¡ÐµÑ€Ð²Ð¸Ñ             | ÐŸÑ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð»Ñ‹       | ÐžÐ±Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ                                                                 |
|--------------------|------------------|------------------------------------------------------------------------------|
| `gateway`          | REST (HTTP/1.1)  | Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Ð´Ð»Ñ Ñ„Ñ€Ð¾Ð½Ñ‚Ð°, Ñ‚Ð¾ÐºÐµÐ½ Ð² Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐµ Authorization         |
| `auth-service`     | gRPC             | ÐŸÑ€Ð¾ÑÑ‚Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ (login, register, verify), Ð½ÐµÑ‚ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð² REST        |
| `session-service`  | gRPC             | Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ, refresh Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÐµÑÑÐ¸Ð¹ â€” ÐºÐ¾Ð¼Ð°Ð½Ð´Ð½Ñ‹Ð¹ ÑÑ‚Ð¸Ð»ÑŒ                     |
| `profile-service`  | REST             | ÐŸÑƒÐ±Ð»Ð¸Ñ‡Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ, Ð¼Ð¾Ð¶Ð½Ð¾ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ, Ñ…Ð¾Ñ€Ð¾ÑˆÐ¾ Ð»Ð¾Ð¶Ð¸Ñ‚ÑÑ Ð² REST              |
| `contact-service`  | gRPC             | Ð¡Ð¾Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ â€” Ñ‡Ð¸ÑÑ‚Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹                                        |
| `messaging-service`| gRPC + Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑŒ   | gRPC Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸/Ñ‡Ñ‚ÐµÐ½Ð¸Ñ, Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑŒ Ð´Ð»Ñ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹ Ð¸ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¹        |

---

## ðŸ” Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ð¹Ð½Ð°Ñ Ð¼Ð¾Ð´ÐµÐ»ÑŒ (Event-driven)

Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ñ Ð¿ÑƒÐ±Ð»Ð¸ÐºÑƒÑŽÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑŒ (Kafka Ð¸Ð»Ð¸ NATS), Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð±ÐµÑÐ¿ÐµÑ‡Ð¸Ñ‚ÑŒ:

- Ð½Ð°Ð´Ñ‘Ð¶Ð½ÑƒÑŽ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÑƒ Ð¸ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
- Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½ÑƒÑŽ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ
- Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¼ÐµÐ¶Ð´Ñƒ ÑÐµÑ€Ð²Ð¸ÑÐ°Ð¼Ð¸

| Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº          | Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ               | ÐŸÐ¾Ð´Ð¿Ð¸ÑÑ‡Ð¸ÐºÐ¸             | ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ                                  |
|-------------------|-----------------------|-------------------------|--------------------------------------------|
| `auth-service`    | `user.created`        | profile, contact        | Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ñ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹                   |
|                   | `user.email_verified` | â€”                       | Ð¡Ñ‚Ð°Ñ‚ÑƒÑ email                               |
| `profile-service` | `profile.updated`     | (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)           | ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð»Ð¸ Ð¸Ð½Ð´ÐµÐºÑÐ°Ñ†Ð¸Ñ                 |
| `contact-service` | `friendship.created`  | (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)           | Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ                                |
|                   | `friendship.accepted` | messaging-service       | Ð Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ Ñ‡Ð°Ñ‚Ð°                            |
|                   | `friendship.removed`  | messaging-service       | ÐŸÑ€ÐµÐºÑ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÐ¼           |
| `messaging-service` | `message.sent`      | (ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ, Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ°)| Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ                 |
|                   | `message.seen`        | (Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ°)             | ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°                         |
| `session-service` | `session.created`     | (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)           | ÐÑƒÐ´Ð¸Ñ‚ Ð²Ñ…Ð¾Ð´Ð¾Ð²                               |
|                   | `session.revoked`     | (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)           | ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð²Ñ‹Ñ…Ð¾Ð´                       |

---

## âš™ï¸ gRPC ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ (ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ñ‹Ðµ Ð²Ñ‹Ð·Ð¾Ð²Ñ‹)

| ÐžÑ‚ÐºÑƒÐ´Ð°           | ÐšÑƒÐ´Ð°              | ÐœÐµÑ‚Ð¾Ð´                    | ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ                          |
|------------------|-------------------|---------------------------|-------------------------------------|
| `gateway`        | `auth-service`    | `Login`, `Register`, `VerifyEmail` | ÐÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ             |
| `gateway`        | `session-service` | `RefreshSession`, `RevokeSession`  | ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸ Ð²Ñ‹Ñ…Ð¾Ð´ Ð¸Ð· ÑÐµÑÑÐ¸Ð¸        |
| `gateway`        | `profile-service` | `GetProfile`, `UpdateProfile`      | ÐŸÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ                   |
| `gateway`        | `contact-service` | `AddFriend`, `RemoveFriend`, `GetFriends` | Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ²ÑÐ·ÑÐ¼Ð¸         |
| `gateway`        | `messaging-service` | `SendMessage`, `GetMessages`, `MarkSeen` | Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Ð¿ÐµÑ€ÐµÐ¿Ð¸ÑÐºÐ¾Ð¹     |
| `messaging-service` | `contact-service` | `IsFriend(userA, userB)`        | ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² Ð¿ÐµÑ€ÐµÐ´ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¾Ð¹       |

---

## Ð‘Ð»Ð¾Ðº-ÑÑ…ÐµÐ¼Ð° Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ (Mermaid)

```mermaid
flowchart TD
    subgraph External
        Client[ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ]
    end

    subgraph EntryPoint
        GW[Gateway Service]
    end

    subgraph AuthLayer
        AUTH[Auth Service]
        SESSION[Session Service]
    end

    subgraph UserLayer
        PROFILE[Profile Service]
        CONTACT[Contact Service]
    end

    subgraph Messaging
        MSG[Messaging Service]
    end

    Client --> GW

    %% Auth
    GW --> AUTH
    AUTH --> SESSION
    GW --> SESSION

    %% Events
    AUTH -- user.created --> PROFILE
    AUTH -- user.created --> CONTACT
    AUTH -- user.email_verified --> PROFILE

    %% Profile
    GW --> PROFILE
    PROFILE -- profile.updated --> /*

    %% Contact
    GW --> CONTACT
    CONTACT -- friendship.accepted --> MSG
    CONTACT -- friendship.removed --> MSG

    %% Messaging
    GW --> MSG
    MSG --> CONTACT

    %% Session
    SESSION -- session.revoked --> Logout
